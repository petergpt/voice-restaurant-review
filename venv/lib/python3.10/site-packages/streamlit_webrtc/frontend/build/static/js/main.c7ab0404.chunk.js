(this.webpackJsonpstreamlit_webrtc=this.webpackJsonpstreamlit_webrtc||[]).push([[0],{114:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),i=n(21),c=n.n(i),o=n(81),s=n(154),l=n(156),u=n(18),d=n(5),b=n.n(d),f=n(8),p=n(1),v=n(4),m=n(11),j=n(10),g=n(2),O=n(3),h=n(27),S=n(121),x=n(84),y=n(157),I=n(77),E=n(79),w=n.n(E),C=n(12),N=function(e){var t=e.theme,n=r.a.useMemo((function(){if(null!=t){var e=w.a.scale([t.textColor,t.backgroundColor]).mode("lab");return Object(o.a)({palette:{primary:{main:t.primaryColor},background:{default:t.backgroundColor,paper:t.secondaryBackgroundColor},text:{primary:t.textColor,secondary:e(.1).hex(),disabled:e(.5).hex()}},typography:{fontFamily:t.font}})}}),[t]);return null==n?Object(C.jsx)(C.Fragment,{children:e.children}):Object(C.jsx)(s.a,{theme:n,children:e.children})},k={width:"100%"},D=function(e){Object(a.useEffect)((function(){h.a.setFrameHeight()}));var t=e.stream.getVideoTracks().length>0,n=Object(a.useCallback)((function(t){t&&(t.srcObject=e.stream)}),[e.stream]),r=Object(a.useCallback)((function(){return h.a.setFrameHeight()}),[]);return t?Object(C.jsx)("video",{style:k,ref:n,autoPlay:!0,controls:!0,onCanPlay:r}):Object(C.jsx)("audio",{ref:n,autoPlay:!0,controls:!0})},R=r.a.memo(D),T=n(115),P=n(118),L=n(155),G=n(80),A=n.n(G),_=Object(T.a)((function(e){return{paper:{padding:e.spacing(4),display:"flex",justifyContent:"center",alignItems:"center"}}})),V=function(e){Object(a.useEffect)((function(){h.a.setFrameHeight()}));var t=_();return Object(C.jsx)(P.a,{className:t.paper,elevation:0,children:e.loading?Object(C.jsx)(L.a,{}):Object(C.jsx)(A.a,{fontSize:"large"})})},Y=r.a.memo(V),M=n(16);function B(e,t,n){var a=e||{};return t&&(!0===a.video?a.video={deviceId:t}:"object"!==typeof a.video&&null!=a.video||(a.video=Object(M.a)(Object(M.a)({},a.video),{},{deviceId:t}))),n&&(!0===a.audio?a.audio={deviceId:n}:"object"!==typeof a.audio&&null!=a.audio||(a.audio=Object(M.a)(Object(M.a)({},a.audio),{},{deviceId:n}))),a}var F=function(e){return"RECVONLY"===e||"SENDONLY"===e||"SENDRECV"===e},H=function(e){return e.createOffer().then((function(t){return console.log("Created offer:",t),e.setLocalDescription(t)})).then((function(){return console.log("Wait for ICE gethering..."),new Promise((function(t){if("complete"===e.iceGatheringState)t();else{e.addEventListener("icegatheringstatechange",(function n(){"complete"===e.iceGatheringState&&(e.removeEventListener("icegatheringstatechange",n),t())}))}}))})).then((function(){return e.localDescription})).catch((function(e){throw console.error(e),e}))},U=function(e){Object(g.a)(n,e);var t=Object(O.a)(n);function n(e){var a;return Object(p.a)(this,n),(a=t.call(this,e)).pc=void 0,a.signallingTimer=void 0,a.processAnswerInner=function(){var e=Object(f.a)(b.a.mark((function e(t,n){var a;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=JSON.parse(n),console.log("Receive answer sdpOffer",a),e.next=4,t.setRemoteDescription(a);case 4:console.log("Remote description is set");case 5:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),a.processAnswer=function(e,t){a.processAnswerInner(e,t).then((function(){a.signallingTimer&&clearTimeout(a.signallingTimer),a.setState({webRtcState:"PLAYING",sdpOffer:null})})).catch((function(e){a.setState({error:e}),a.stop()}))},a.startInner=Object(f.a)(b.a.mark((function e(){var t,n,r,i,c,o,s,l,d,f,p;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.props.args.mode,F(n)){e.next=3;break}throw new Error("Invalid mode ".concat(n));case 3:if(a.setState({webRtcState:"SIGNALLING",stream:null,error:null}),r=(null===(t=a.props.args.settings)||void 0===t?void 0:t.rtc_configuration)||{},console.log("RTCConfiguration:",r),i=new RTCPeerConnection(r),"SENDRECV"!==n&&"RECVONLY"!==n||i.addEventListener("track",(function(e){var t=e.streams[0];a.setState({stream:t})})),"SENDRECV"!==n&&"SENDONLY"!==n){e.next=23;break}if(l=B(null===(c=a.props.args.settings)||void 0===c?void 0:c.media_stream_constraints,null===(o=a.state.videoInput)||void 0===o?void 0:o.deviceId,null===(s=a.state.audioInput)||void 0===s?void 0:s.deviceId),console.log("MediaStreamConstraints:",l),!l.audio&&!l.video){e.next=20;break}if(null!=navigator.mediaDevices){e.next=14;break}throw new Error("navigator.mediaDevices is undefined. It seems the current document is not loaded securely.");case 14:if(null!=navigator.mediaDevices.getUserMedia){e.next=16;break}throw new Error("getUserMedia is not implemented in this browser");case 16:return e.next=18,navigator.mediaDevices.getUserMedia(l);case 18:(d=e.sent).getTracks().forEach((function(e){i.addTrack(e,d)}));case 20:if("SENDONLY"===n){f=Object(u.a)(i.getTransceivers());try{for(f.s();!(p=f.n()).done;)p.value.direction="sendonly"}catch(b){f.e(b)}finally{f.f()}}e.next=24;break;case 23:"RECVONLY"===n&&(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}));case 24:return console.log("transceivers",i.getTransceivers()),a.pc=i,e.next=28,H(i).then((function(e){if(null==e)throw new Error("Failed to create an offer SDP");a.setState({sdpOffer:e})}));case 28:case"end":return e.stop()}}),e)}))),a.start=function(){"STOPPED"===a.state.webRtcState&&(a.setState({signallingTimedOut:!1}),a.signallingTimer=setTimeout((function(){a.setState({signallingTimedOut:!0})}),1e4),a.startInner().catch((function(e){return a.setState({webRtcState:"STOPPED",sdpOffer:null,error:e})})))},a.stopInner=Object(f.a)(b.a.mark((function e(){var t;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("STOPPING"!==a.state.webRtcState){e.next=2;break}return e.abrupt("return");case 2:if(t=a.pc,a.pc=void 0,a.setState({webRtcState:"STOPPING",sdpOffer:null}),null!=t){e.next=7;break}return e.abrupt("return");case 7:return t.getTransceivers&&t.getTransceivers().forEach((function(e){e.stop&&e.stop()})),t.getSenders().forEach((function(e){var t;null===(t=e.track)||void 0===t||t.stop()})),e.abrupt("return",new Promise((function(e){setTimeout((function(){t.close(),e()}),500)})));case 10:case"end":return e.stop()}}),e)}))),a.stop=function(){a.stopInner().catch((function(e){return a.setState({error:e})})).finally((function(){a.setState({webRtcState:"STOPPED",sdpOffer:null,stream:null})}))},a.reconcilePlayingState=function(){var e=a.props.args.desired_playing_state;null!=e&&(!0===e&&"STOPPED"===a.state.webRtcState?a.start():!1!==e||"SIGNALLING"!==a.state.webRtcState&&"PLAYING"!==a.state.webRtcState||a.stop())},a.reconcileComponentValue=function(e){if(a.state!==e){var t="PLAYING"===a.state.webRtcState,n=t!==("PLAYING"===e.webRtcState),r=a.state.sdpOffer,i=e.sdpOffer;(n||r!==i)&&(r&&console.log("Send SDP offer",r),h.a.setComponentValue({playing:t,sdpOffer:r?r.toJSON():""}))}},a.handleDeviceSelect=function(e,t){a.setState({videoInput:e,audioInput:t})},a.render=function(){var e,t,n=a.props.args.desired_playing_state,r=a.props.disabled||"SIGNALLING"===a.state.webRtcState&&!a.state.signallingTimedOut||"STOPPING"===a.state.webRtcState||null!=n,i=a.props.args.mode,c={videoEnabled:!(t=null===(e=a.props.args.settings)||void 0===e?void 0:e.media_stream_constraints)||!!t.video,audioEnabled:!t||!!t.audio},o=c.videoEnabled,s=c.audioEnabled,l=F(i)&&function(e){return"SENDRECV"===e||"RECVONLY"===e}(i),u=F(i)&&function(e){return"SENDRECV"===e||"SENDONLY"===e}(i);return Object(C.jsx)(N,{theme:a.props.theme,children:Object(C.jsxs)(S.a,{children:[a.state.error&&Object(C.jsxs)(y.a,{severity:"error",children:[a.state.error.name,": ",a.state.error.message]}),Object(C.jsx)(S.a,{py:1,children:a.state.stream?Object(C.jsx)(R,{stream:a.state.stream}):l&&Object(C.jsx)(Y,{loading:"SIGNALLING"===a.state.webRtcState})}),Object(C.jsxs)(S.a,{display:"flex",justifyContent:"space-between",children:["PLAYING"===a.state.webRtcState||"SIGNALLING"===a.state.webRtcState?Object(C.jsx)(x.a,{variant:"contained",onClick:a.stop,disabled:r,children:"Stop"}):Object(C.jsx)(x.a,{variant:"contained",color:"primary",onClick:a.start,disabled:r,children:"Start"}),u&&Object(C.jsx)(I.a,{videoEnabled:o,audioEnabled:s,onSelect:a.handleDeviceSelect,value:{video:a.state.videoInput,audio:a.state.audioInput}})]})]})})},a.state={webRtcState:"STOPPED",sdpOffer:null,signallingTimedOut:!1,videoInput:null,audioInput:null,stream:null,error:null},a}return Object(v.a)(n,[{key:"componentDidMount",value:function(){Object(m.a)(Object(j.a)(n.prototype),"componentDidMount",this).call(this),this.reconcilePlayingState()}},{key:"componentDidUpdate",value:function(e,t){if(Object(m.a)(Object(j.a)(n.prototype),"componentDidUpdate",this).call(this),this.reconcilePlayingState(),this.reconcileComponentValue(t),null!=this.pc){var a=this.pc;if(null==a.remoteDescription){var r=this.props.args.sdp_answer_json;r!==e.args.sdp_answer_json&&r&&"SIGNALLING"===this.state.webRtcState&&this.processAnswer(a,r)}}}}]),n}(h.b),W=Object(h.c)(U),J=Object(o.a)({overrides:{MuiCssBaseline:{"@global":{body:{backgroundColor:"initial"}}}}});c.a.render(Object(C.jsx)(r.a.StrictMode,{children:Object(C.jsxs)(s.a,{theme:J,children:[Object(C.jsx)(l.a,{}),Object(C.jsx)(W,{})]})}),document.getElementById("root"))},77:function(e,t,n){"use strict";(function(e){var a=n(18),r=n(15),i=n(0),c=n.n(i),o=n(27),s=n(121),l=n(115),u=n(84),d=n(73),b=n(86),f=n(85),p=n(123),v=n(119),m=n(118),j=n(12),g=Object(l.a)((function(e){return{paper:{padding:e.spacing(2)},formControl:{maxWidth:"80vw",margin:e.spacing(1),minWidth:120,display:"flex"},formButtonControl:{margin:e.spacing(2),marginBottom:e.spacing(1),minWidth:120,display:"flex"},selectEmpty:{marginTop:e.spacing(2)}}})),O=function(t){var n=t.labelId,a=t.value,r=t.devices,c=t.onChange,o=g(),s=Object(i.useCallback)((function(e){var t=r.find((function(t){return t.deviceId===e.target.value}));c(t||null)}),[r,c]);return 0===r.length?Object(j.jsx)(f.a,{value:"",disabled:!0,children:Object(j.jsx)("option",{"aria-label":"None",value:""})}):null==a?(e((function(){return c(r[0])})),null):Object(j.jsx)(f.a,{labelId:n,value:a.deviceId,onChange:s,className:o.selectEmpty,children:r.map((function(e){return Object(j.jsx)(p.a,{value:e.deviceId,children:e.label},e.deviceId)}))})},h=function(e){var t=e.open,n=e.anchorEl,a=e.videoEnabled,c=e.audioEnabled,s=e.value,l=e.devicesMap,f=e.onSubmit,p=Object(i.useState)(null),h=Object(r.a)(p,2),S=h[0],x=h[1],y=Object(i.useState)(null),I=Object(r.a)(y,2),E=I[0],w=I[1];Object(i.useEffect)((function(){x(l.video.find((function(e){var t;return e.deviceId===(null===(t=s.video)||void 0===t?void 0:t.deviceId)}))||null),w(l.audio.find((function(e){var t;return e.deviceId===(null===(t=s.audio)||void 0===t?void 0:t.deviceId)}))||null)}),[l,s]);var C=Object(i.useCallback)((function(e){e.preventDefault(),f(a?S:null,c?E:null)}),[f,a,c,S,E]),N=g(),k=Object(i.useRef)(),D=Object(i.useCallback)((function(e){if(e)setTimeout((function(){var t=document.getElementsByTagName("body")[0];k.current=t.style.height;var n=window.getComputedStyle(e),a=new WebKitCSSMatrix(n.transform).m42+e.getBoundingClientRect().height;a>document.body.scrollHeight&&(t.style.height="".concat(a,"px"),o.a.setFrameHeight())}),0);else{var t=document.getElementsByTagName("body")[0];null!=k.current&&(t.style.height=k.current),o.a.setFrameHeight()}}),[]);return Object(j.jsx)(v.a,{ref:D,open:t,anchorEl:n,placement:"left-end",children:Object(j.jsx)(m.a,{className:N.paper,children:Object(j.jsxs)("form",{onSubmit:C,children:[a&&Object(j.jsxs)(d.a,{className:N.formControl,children:[Object(j.jsx)(b.a,{id:"video-input-select",children:"Video input"}),Object(j.jsx)(O,{labelId:"video-input-select",devices:l.video,value:S,onChange:x})]}),c&&Object(j.jsxs)(d.a,{className:N.formControl,children:[Object(j.jsx)(b.a,{id:"audio-input-select",children:"Audio input"}),Object(j.jsx)(O,{labelId:"audio-input-select",devices:l.audio,value:E,onChange:w})]}),Object(j.jsx)(d.a,{className:N.formButtonControl,children:Object(j.jsx)(u.a,{type:"submit",variant:"contained",color:"primary",children:"OK"})})]})})})},S=function(e){var t=e.videoEnabled,n=e.audioEnabled,o=e.value,l=e.onSelect,d=Object(i.useState)(!1),b=Object(r.a)(d,2),f=b[0],p=b[1],v=c.a.useState(null),m=Object(r.a)(v,2),g=m[0],O=m[1],S=Object(i.useState)(),x=Object(r.a)(S,2),y=x[0],I=x[1],E=Object(i.useState)(!1),w=Object(r.a)(E,2),C=w[0],N=w[1],k=Object(i.useCallback)((function(e){var t,n;if(O(e.currentTarget),"function"!==typeof(null===(t=navigator)||void 0===t||null===(n=t.mediaDevices)||void 0===n?void 0:n.enumerateDevices))return I(void 0),void N(!0);navigator.mediaDevices.enumerateDevices().then((function(e){var t,n=[],r=[],i=Object(a.a)(e);try{for(i.s();!(t=i.n()).done;){var c=t.value;"videoinput"===c.kind?n.push(c):"audioinput"===c.kind&&r.push(c)}}catch(o){i.e(o)}finally{i.f()}I({video:n,audio:r}),p(!0)}))}),[]),D=Object(i.useCallback)((function(){return p(!1)}),[]),R=Object(i.useCallback)((function(e,t){I(void 0),p(!1),l(e,t)}),[l]);return Object(j.jsxs)(s.a,{children:[C&&Object(j.jsx)("p",{children:"Unavailable"}),y&&Object(j.jsx)(h,{open:f,anchorEl:g,videoEnabled:t,audioEnabled:n,value:o,devicesMap:y,onSubmit:R}),Object(j.jsx)(u.a,{onClick:f?D:k,children:"Select device"})]})};t.a=c.a.memo(S)}).call(this,n(103).setImmediate)}},[[114,1,2]]]);
//# sourceMappingURL=main.c7ab0404.chunk.js.map